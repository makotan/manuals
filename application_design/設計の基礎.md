# 設計の前提知識

過去に見た範囲の色んな設計を抽象化したもの  

	         外部サービス
	           ↑　↓
	入力  ->    処理    ->  出力
	           ↑  ↓
	         内部データ
	

ソフトウェアを設計するというのは、その入力と出力、内部のデータとのやりとり、外部サービスとのやりとりを必要十分な量を考えて記述すると言うこと  
しっかり考える事でソフトウェアの実装時に想定外を発生させずにバグの少ない実装が可能になる  

# よくある設計手法について
具体的な名称は全部端折って設計手法を分類するとこの3つにまとまる  
- データに注目したもの
- プログラムの構造に注目したもの
- 処理の繋がりに注目したもの

設計の軸足を何処に置くかが設計手法によってかなり異なる物がある  
共通して言えることは**要件をどう綺麗にマッピングするか**を考慮した結果存在して居る  
どの手法が良い・悪い・新しい・古いではない  
注目ポイントの異なる手法は積極的に学習する意味があるということ  

# 設計の記述内容
基本的には関係する5種類の情報が正確に定義されていれば良い  
ただし、プロジェクトのルールや実装するアーキテクチャなどによって記述の水準は変わる  
大事なことは、仕様書フォーマットに拘らず必要な情報を漏れなく記述すること  

# データの定義
比較的簡単な入力だけに限っても色んな入力パターンがある
- 正常な入力
- パラメータが異常な入力
- データ構造が異常な入力
- 整合性の取れてないデータの入力

これが出力になると、エラー毎に出力方法を決めたり、入力値に合わせた出力をすることになって定義する量は増える  
内部データに関しては処理の時間より遙かに長いので他の処理との整合性を考慮する必要が出てくる  

# 予想外の処理の制御
プログラムの大半は何らかの予想外の挙動の制御になる  
予想外の事を考慮漏れするとバグや重大な問題を発生させ易くなる  
プログラミング言語やライブラリが持つ機能を最大限に活用して発生を抑止する事  
それでも対応しないといけない部分にはしっかり検討して対応する事  
ここまでやると**ほぼちゃんと動くプログラム**が出来上がる  
さらに外部サービス(場合によっては依存関係のあるプログラム全て)にが持つ前提をしっかり実装する  
ここまでやると多少の変更にも強い**かなり丈夫なプログラム**になる  

# ソフトウェアの制約
ソフトウェアの設計時に大事なのは**制約を決めること**  
ここでいう制約とはデータの定義や、データ間の関連、外部サービスがエラーになったときの挙動、データの状態と遷移  
これらが実装時と運用・保守時にかなり大きな影響を及ぼす  

# 制約と自由度
大抵は制約を追加する(自由度を弱く)する方向で設計する  
制約を取り除けば取り除くほどプログラムが複雑になる  
要件を満たす最小限の制約でかつプログラムが複雑になりすぎない限りにおいて、制約を削減するのは望ましい  
制約を後から取り除くと想定外の所に影響が出たりバグ(設計・実装レベル共)が発生したりする  

# パフォーマンスとサイズ
最近はお金さえ出せばかなり巨大なデータを扱うソフトウェアが動かせるレベルの物が容易に手に入る  
だからといってパフォーマンスに無頓着に実装してしまうと、無限にサーバ費用がかかることになる  
(もちろん、それでも利益が出るなら良いかもしれない)  
なので、設計時点から最低限のパフォーマンスの考慮が必要  

## 入出力のサイズ
データの入出力のサイズは小さいほど良い  
小さくする方法は色々あるものの、基本的に無制限に大きくならないように気をつける  
入出力は後から変更不可能な事も多いので、特に注意する  

## 内部データのサイズとI/O
内部データもなるべくなら小さい方が良い  
ここでの注意点は**I/Oサイズが大きくなるとパフォーマンスへのインパクトも大きくなる**ということ  
内部データは適切な正規化により小さく出来るので可能な範囲で正規化をする  
ただし、それによりI/Oコストが増大しすぎる場合は非正規化をしてI/Oコストを下げる  
非正規化は運用面では高コストになり得ることに特に注意する  

## 同時リクエスト数と接続数と接続時間
主にサーバサイドのアプリケーションの話  
RDBなどを使っているサービスの場合、DBのコネクションの上限がくるとサービスが事実上エラーになりやすい  
この辺の見極めも設計時の想定として重要  
特に外部サービスが接続エラーになるような場合、サーバの性能が余っていてもエラーの挙動になることがある  
適切なリトライ・タイムアウトなどの実装と設定が必要  

## スレッド化と非同期化
普通にプログラムを作ると1つのスレッドでシーケンシャルに実行する  
このままだと、I/O待ちでCPUが空くので他の処理を入れて且つメモリーを共有してマルチスレッド化する  
処理単位にスレッド(or プロセス)を作れば単一サーバ上でもそれだけ簡単に複数個の処理が出来るようになる  
待ちの後非常に短時間でスレッドが処理を開始出来るのでパフォーマンス的にはスレッド処理は良い  
ただし、処理数が多くなりすぎるとCPUのスレッド管理用のタスクとメモリーの使用量が大きくなって悪化する(CPUのパフォーマンス監視すると良い)  
これを回避するには、処理自体の非同期化を行う  
スレッド数を少なくして複数のスレッドが複数(かなり多数)の処理を引き受ける形式  
結果的に同時実行数を増やすことが出来る  
スレッド化も非同期化も言語やライブラリがサポートしてる事が多い  
非同期化処理はプログラミング言語で扱いづらい事が多かった(ここから先解消していくと思う)  
スレッド処理にするか、非同期化の処理にするかについてはしっかり検討する必要がある  
非同期化してもDBサーバなどの接続上限は超えれないなどの制約はある  
個人的には一般的なWebサービス程度の実装ならスレッド処理で十分という認識  


